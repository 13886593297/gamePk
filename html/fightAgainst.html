<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>PK</title>
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="../css/base.css">
	<link rel="stylesheet" href="../css/animate.css">
	<link rel="stylesheet" href="../css/fightAgainst.css">
	<script src="../js/vconsole.min.js"></script>
	<script src="../js/jweixin-1.0.0.js"></script>
	<script src="../js/jquery.min.js"></script>
	<script src="../js/base.js"></script>
	<script src="../js/timer.jquery.js"></script>
	<script src="../js/bg_music.js"></script>
	<script src="../js/index.js"></script>
	<script src="../js/shape.js"></script>
</head>

<body>
	<audio src="../music/time_out.mp3" id="timeOut" loop></audio>
	<audio src="../music/select_click.mp3" id="selectClick"></audio>
	<div class="match_info">
		<p>本场PK剩余时间：<br><span id="remaining_time">2h59m59s</span></p>
		<p>本场已完成PK人数：<span id="person_num">0</span></p>
		<p>累计用时：<span id="match_time">0s</span></p>
	</div>
	<div class="page_bg">
		<div id="time">20</div>
		<span id="num"></span>
		<div class="container scrollbar">
			<div class="animated" id="title_div">
				<span id="title"></span>
			</div>
			<div class="answer animated " onclick="doAnswer(this.id)" id="1">
				<input type="radio" name="firstname">
				<img id="1Img" name="img" src="../images/no_select.png" />
				<span id="1Text" name="text"></span>
			</div>
			<div class="answer animated " onclick="doAnswer(this.id)" id="2">
				<input type="radio" name="firstname">
				<img id="2Img" name="img" src="../images/no_select.png" />
				<span id="2Text" name="text"></span>
			</div>
			<div class="answer animated " onclick="doAnswer(this.id)" id="3">
				<input type="radio" name="firstname">
				<img id="3Img" name="img" src="../images/no_select.png" />
				<span id="3Text" name="text"></span>
			</div>
			<div class="answer animated " onclick="doAnswer(this.id)" id="4">
				<input type="radio" name="firstname">
				<img id="4Img" name="img" src="../images/no_select.png" />
				<span id="4Text" name="text"></span>
			</div>
			<div class="answer animated " onclick="doAnswer(this.id)" id="5">
				<input type="radio" name="firstname">
				<img id="5Img" name="img" src="../images/no_select.png" />
				<span id="5Text" name="text"></span>
			</div>
			<div class="answer animated " onclick="doAnswer(this.id)" id="6">
				<input type="radio" name="firstname">
				<img id="6Img" name="img" src="../images/no_select.png" />
				<span id="6Text" name="text"></span>
			</div>
		</div>
	</div>
	<div id="footView">
		<div class="footerbg"></div>
		<img id="img_adinfo" src="../images/ad_logo01.png">
		<div id="test_adinfo">强效促成骨 提高骨质量 预防再骨折</div>
	</div>
</body>

<script>
	getUserInfo()
	var ffllaagg = 0;
	var question_index = 0;
	var bodys;
	var optionAnswer;
	var selectCorrect = 0,
		level_score = 0;

	var pkid = getQueryString('pkId');
	getAllQuestion();
	//查询题目
	function getAllQuestion() {
		$.ajax({
			url: baseUrl.base + baseUrl.questions,
			type: 'post',
			// url: '../../fightAgainst.json',
			async: false,
			data: {
				userId: getCookie('userId'),
				pkId: pkid
			},
			success: function (res) {
				console.log(res.msg)
				if (res.code == 0) {
					// $('.answer ').show();
					$('#person_num').html(res.body.userCount)
					bodys = res.body.questions;
					question_index = 0;
					showQuestion();
					showAdInfo(0);
					addTime()
					residueute(res.body.time)
				} else if (res.code == 2) {
					history.go(-(history.length - 2));
					return true;
				} else if (res.code == 11) {
					alert("您已经答过题了")
					history.go(-(history.length - 2));
					return true;
				}
			}
		})
	}

	function addTime() {
		var tim = 0;
		$('#match_time').everyTime('1s', function () {
			tim++;
			$("#match_time").html(tim + "s");
		});
	}

	function residueute(time) {
		$('#match_time').everyTime('1s', function () {
			time = time - 1;
			chu(time)
		});
	}

	//展示题目
	function showQuestion() {
		var span = document.getElementsByName('text');
		for (var i = 0; i < span.length; i++) {
			$("#" + (i + 1) + "Img").attr("src", "../images/no_select.png");
		}
		for (var i = 0; i < span.length; i++) {
			$("#" + (i + 1) + "Text").css("color", "#000000");
		}
		a = 20;
		//倒计时
		$('body').everyTime('1s', function () {
			a = a - 1;
			$("#time").html(a);
			if (a <= 0) {
				doAnswer(0)
				a = 20;
				$('body').stopTime();
				showQuestion();
				return;
			}
		});
		if (question_index > 0) {
			$('body').oneTime('0s', hideAnimation);
		}
		if (question_index >= bodys.length) {
			alert('您已完成PK邀请答题，请稍后进入PK中心查看结果')
			if (window.history.length > 3) {
				window.location.href = '../html/pkRecord.html'
			} else {
				window.location.href = '../html/pkRecord.html'
			}
			return true;
		} else {
			$('body').oneTime('1s', function () {
				$('.answer ').show();
				if (bodys[question_index - 1].option_c == '') {
					$('#3').hide();
				}
				if (bodys[question_index - 1].option_d == '') {
					$('#4').hide();
				}
				if (!bodys[question_index - 1].option_e || bodys[question_index - 1].option_e == '') {
					$('#5').hide();
				}
				if (!bodys[question_index - 1].option_f || bodys[question_index - 1].option_f == '') {
					$('#6').hide();
				}
				$("#num").html((question_index) + "/" + bodys.length);
				$("#title").html(bodys[question_index - 1].question_content);
				$("#1Text").html(bodys[question_index - 1].option_a);
				$("#2Text").html(bodys[question_index - 1].option_b);
				$("#3Text").html(bodys[question_index - 1].option_c);
				$("#4Text").html(bodys[question_index - 1].option_d);
				$("#5Text").html(bodys[question_index - 1].option_e);
				$("#6Text").html(bodys[question_index - 1].option_f);
				optionAnswer = bodys[question_index - 1].option_answer;
			})
		}
		$('body').oneTime('1s', showAnimation);
		question_index++;
	}

	//答题
	function doAnswer(sId) {
		$('#1').removeAttr('onclick');
		$('#2').removeAttr('onclick');
		$('#3').removeAttr('onclick');
		$('#4').removeAttr('onclick');
		$('#5').removeAttr('onclick');
		$('#6').removeAttr('onclick');
		var select = optionAnswer;
		$('body').stopTime();
		if (sId == select) {
			selectCorrect++;
			$("#" + sId + "Img").attr("src", "../images/right.png");
			$("#" + sId + "Text").css("color", "#2661b4");
			level_score = level_score + bodys[question_index - 1].level_score;
		} else {
			$("#" + sId + "Img").attr("src", "../images/error.png");
			$("#" + sId + "Text").css("color", "#fd8900");
			// $("#" + select + "Img").attr("src", "../images/right.png");
			// $("#" + select + "Text").css("color", "#ec8bb4");
		}
		sumbit(bodys[parseInt(question_index) - 1].question_id, (parseInt(sId)), question_index);
		showAdInfo(parseInt(question_index) - 1);

		if (question_index >= bodys.length) {
			ffllaagg = ffllaagg + 1;
			if (ffllaagg == 1) {

			}
			return true;
		}

		$('body').oneTime('2.5s', function () {
			$('#time').html(20);
			showQuestion();
		});
	}	

	function sumbit(questionId, answerOption, position) {
		if (sessionStorage.getItem('isplay') == 0) {
			document.getElementById('selectClick').play();
		}
		$.ajax({
			url: baseUrl.base + baseUrl.toanswerpk,
			type: 'post',
			data: {
				userId: getCookie('userId'),
				answerOption: answerOption,
				questionId: questionId,
				pkId: pkid
			},
			success: function (res) {
				if (res.code == 0) {
					if (position == bodys.length) {
						if (question_index == bodys.length) {
							ffllaagg = ffllaagg + 1;
							alert('您已完成PK邀请答题，请稍后进入PK中心查看结果')
							window.location.href = '../html/pkRecord.html'
							return;
						}
					}
				}
			}
		})
	}

	var a = 21;

	function showAnimation() {
		//  展示下一题
		//$("#title_div").removeClass("fadeIn");
		$('.container').scrollTop(0)
		$("#title").removeClass("fadeOut");
		$("#title").addClass("fadeIn");
		$("#1").removeClass("fadeOut");
		$("#1").addClass("fadeIn");
		$("#2").removeClass("fadeOut");
		$("#2").addClass("fadeIn");
		$("#3").removeClass("fadeOut");
		$("#3").addClass("fadeIn");
		$("#4").removeClass("fadeOut");
		$("#4").addClass("fadeIn");
		$("#5").removeClass("fadeOut");
		$("#5").addClass("fadeIn");
		$("#6").removeClass("fadeOut");
		$("#6").addClass("fadeIn");

		$("#1").attr("onclick", "doAnswer(1);");
		$("#2").attr("onclick", "doAnswer(2);");
		$("#3").attr("onclick", "doAnswer(3);");
		$("#4").attr("onclick", "doAnswer(4);");
		$("#5").attr("onclick", "doAnswer(5);");
		$("#6").attr("onclick", "doAnswer(6);");
	}

	function hideAnimation() { //  展示下一题
		//$("#title_div").removeClass("fadeIn");
		$("#title").removeClass("fadeIn");
		$("#title").addClass("fadeOut");
		$("#1").removeClass("fadeIn");
		$("#1").addClass("fadeOut");
		$("#2").removeClass("fadeIn");
		$("#2").addClass("fadeOut");
		$("#3").removeClass("fadeIn");
		$("#3").addClass("fadeOut");
		$("#4").removeClass("fadeIn");
		$("#4").addClass("fadeOut");
		$("#5").removeClass("fadeIn");
		$("#5").addClass("fadeOut");
		$("#6").removeClass("fadeIn");
		$("#6").addClass("fadeOut");
	}
	
	function chu(time) {
		var h = parseInt(time / 3600);
		var m = parseInt(time % 3600 / 60);
		var s = parseInt(time % 3600 % 60);
		$("#remaining_time").html(h + "h" + m + "m" + s + "s");
	}

	function autoPlayAudio2() {
		wx.config({
			// 配置信息, 即使不正确也能使用 wx.ready
			debug: false,
			appId: '',
			timestamp: 1,
			nonceStr: '',
			signature: '',
			jsApiList: []
		});
		wx.ready(function () {
			if (sessionStorage.getItem('isplay') == 0) {
				document.getElementById('timeOut').play();
			}
		});
	}
	autoPlayAudio2()
</script>

</html>